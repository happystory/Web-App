<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <!-- 禁止了把数字转化为拨号链接 -->
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="css/reset.css">
    <style type="text/css">
    html {
        width: 100%;
        height: 100%;
        overflow-x: hidden;
    }
    
    body {
        /* 取消iOS的Safari浏览器中的链接或JavaScript的可点击的元素时覆盖显示的高亮颜色 */
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        /* 禁止选中 */
        -webkit-user-select: none;
        /* 禁用系统默认菜单 */
        -webkit-touch-callout: none;
        text-align: left;
        width: 100%;
        overflow: hidden;
        background: #e9dfc7;
    }
    
    .m-read-content {
        font-size: 14px;
        color: #555;
        line-height: 31px;
        padding: 15px;
    }
    
    .m-read-content h4 {
        font-size: 20px;
        color: #736357;
        border-bottom: 1px solid #736357;
        letter-spacing: 2px;
        margin: 0 0 1em 0;
    }
    
    .m-read-content p {
        text-indent: 2em;
        margin: 0.5em 0;
        letter-spacing: 0px;
        line-height: 24px;
    }
    
    .m-button-bar {
        width: 70%;
        max-width: 800px;
        padding: 5px;
        margin: 0 auto;
    }
    
    .m-button-bar .u-tab {
        height: 34px;
        margin: 10px auto;
        line-height: 34px;
        border-radius: 8px;
        border: 1px solid #858382;
        font-size: 12px;
        background: #000;
        opacity: 0.9;
    }
    
    .m-button-bar .u-tab li {
        display: inline-block;
        width: 49%;
        border-right: 1px solid #858382;
        text-align: center;
        color: #fff;
    }
    
    .m-button-bar .u-tab li:nth-child(2) {
        border-right: none;
    }

    /* 顶部导航条 */
    .top-nav {
        position: fixed;
        top: 0;
        height: 50px;
        width: 100%;
        z-index: 9999;
        background: #000;
    }
    
    .top-nav .icon-back {
        position: absolute;
        top: 14px;
        left: 10px;
        width: 23px;
        height: 23px;
        background: url(img/icon-back.png);
        background-size: contain;
    }
    
    .nav-title {
        position: absolute;
        top: 16px;
        left: 42px;
        color: #d5d5d6;
    }
    
    .bottom-nav {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 70px;
        z-index: 999;
        background: #000;
        opacity: 0.9;
    }
    
    /* 底部边栏 */
    .bottom-nav a {
        display: block;
        width: 25%;
        height: 70px;
        font-size: 10px;
        line-height: 21px;
        color: #fff;
        float: left;
        text-align: center;
    }
    
    .bottom-nav a:before {
        content: '';
        display: block;
        margin: 18px auto 0;
    }
    
    .bottom-nav .bottom-nav-menu:before {
        margin-bottom: 9px;
        width: 18px;
        height: 13px;
        background: url(img/icon-menu.png) no-repeat;
        background-size: 18px 13px;
    }
    
    .bottom-nav .bottom-nav-menu:after {
        content: '目录';
    }

    .bottom-nav .bottom-nav-font:before {
        margin-bottom: 9px;
        width: 20px;
        height: 13px;
        background: url(img/icon-font.png) no-repeat;
        background-size: 20px 13px;
    }
    
    .bottom-nav .bottom-nav-font:after {
        content: '字体';
    }

    .current:before {
    	background: url(img/icon-font-active.png) no-repeat !important;
        background-size: 20px 13px !important;
    }
    
    .bottom-nav .bottom-nav-night:before {
        margin-bottom: 6px;
        width: 16px;
        height: 16px;
        background: url(img/icon-night.png) no-repeat;
        background-size: 16px 16px;
    }
    
    .bottom-nav .bottom-nav-night:after {
        content: '夜间';
    }
    
    .bottom-nav .bottom-nav-day:before {
        margin-bottom: 4px;
        width: 19px;
        height: 18px;
        background: url(img/icon-day.png) no-repeat;
        background-size: 19px 18px;
    }
    
    .bottom-nav .bottom-nav-day:after {
        content: '日间';
    }
    
    .bottom-nav .bottom-nav-download:before {
        margin-bottom: 5px;
        width: 22px;
        height: 17px;
        background: url(img/icon-download.png) no-repeat;
        background-size: 22px 17px;
    }
    
    .bottom-nav .bottom-nav-download:after {
        content: '下载';
    }
    
    .nav-pannel-bk {
        position: fixed;
        bottom: 70px;
        height: 135px;
        width: 100%;
        background: #000;
        opacity: 0.9;
        z-index: 10002;
    }
    
    .nav-pannel {
        position: fixed;
        bottom: 70px;
        height: 135px;
        width: 100%;
        background: none;
        color: #fff;
        z-index: 10003;
    }
    
    .nav-pannel .child-mod {
        padding: 5px 10px;
        margin: 15px;
    }
    
    .nav-pannel .child-mod span {
        display: inline-block;
        padding-right: 20px;
        padding-left: 10px;
    }
    
    .nav-pannel .child-mod .font-size-button {
        background: none;
        border: 1px #8c8c8c solid;
        color: #fff;
        border-radius: 16px;
        padding: 5px 40px;
        outline: none;
    }
    
    .child-mod button:nth-child(2) {
        margin-right: 10px;
    }
    
    .bk-container {
        position: relative;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: inline-block;
        vertical-align: middle;
        margin-right: 5px;
    }
    
    .bk-container-bg1 {
        background-color: #e9dfc7;
    }
    
    .bk-container-bg2 {
        background-color: #fff;
    }
    
    .bk-container-bg3 {
        background-color: #a4a4a4;
    }
    
    .bk-container-bg4 {
        background-color: #cdefce;
    }
    
    .bk-container-bg5 {
        background-color: #283548;
    }
    
    .bk-container .bk-container-current {
        position: absolute;
        top: -2px;
        left: -2px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px #ff7800 solid;
        display: inline-block;
    }
    
    .artical-action-mid {
        position: fixed;
        z-index: 10001;
        width: 100%;
        height: 40%;
        top: 30%;
    }
    </style>
</head>

<body>
    <div id="root" class="container">
        <!-- 中央唤醒区 -->
        <div class="m-artical-action">
            <div id="action_mid" class="artical-action-mid"></div>
        </div>
        <!-- 顶部导航条 -->
        <div id="top-nav" class="top-nav" style="display:none;">
            <div class="icon-back"></div>
            <div class="nav-title">返回书架</div>
        </div>
        <div id="fiction_chapter_title"></div>
        <div id="fiction_container" class="m-read-content"></div>
        <div class="m-button-bar">
            <ul class="u-tab">
                <li id="prev_button">上一章</li>
                <li id="next_button">下一章</li>
            </ul>
        </div>

        <!-- 底部边栏 -->
        <div id="bottom-nav" class="bottom-nav" style="display:none;">
            <a href="javascript:void(0);" class="bottom-nav-menu"></a>
            <a href="javascript:void(0);" class="bottom-nav-font" id="font-button"></a>
            <a href="javascript:void(0);" class="bottom-nav-night" id="night-button"></a>
            <a href="javascript:void(0);" class="bottom-nav-day" id="day-button" style="display:none;"></a>
            <a href="javascript:void(0);" class="bottom-nav-download"></a>
        </div>
     
     	<!-- 字体面板背景 -->
     	<div class="nav-pannel-bk font-container" style="display:none;"></div>

        <!-- 字体面板 -->
        <div class="nav-pannel font-container" style="display:none;">   	
            <div class="child-mod">
                <span>字号</span>
                <button id="large-font" class="font-size-button">大</button>
                <button id="samll-font" class="font-size-button">小</button>
            </div>
            <div class="child-mod">
                <span>背景</span>
                <div class="bk-container bk-container-bg1">
                    <div class="bk-container-current"></div>
                </div>
                <div class="bk-container bk-container-bg2"></div>
                <div class="bk-container bk-container-bg3"></div>
                <div class="bk-container bk-container-bg4"></div>
                <div class="bk-container bk-container-bg5"></div>
            </div>
        </div>
    </div>
    <script src="lib/zepto.min.js"></script>
    <script>
    window.jQuery = $;
    </script>
    <script src="js/jquery.jsonp.js"></script>
    <script src="js/jquery.base64.js"></script>
    <script>
    (function() {
    	'use strict';
        var Util = (function() {
            var prefix = 'html5_reader_';
            var StorageGetter = function(key) {
                return localStorage.getItem(prefix + key);
            };
            var StorageSetter = function(key, val) {
                return localStorage.setItem(prefix + key, val);
            };
            var getJSONP = function(url, callback) {
                return $.jsonp({
                    url: url,
                    cache: true,
                    callback: 'duokan_fiction_chapter',
                    success: function(result) {
                        var data = $.base64.decode(result);
                        // 可以不使用jquery插件，写成var data = window.atob(result);
                        // 参考https://developer.mozilla.org/zh-CN/docs/Web/API/WindowBase64/btoa
                        var json = decodeURIComponent(escape(data));
                        callback(json);
                    }
                });
            };
            return {
                StorageGetter: StorageGetter,
                StorageSetter: StorageSetter,
                getJSONP: getJSONP
            }
        })();

        var Dom = {
            top_nav: $('#top-nav'),
            bottom_nav: $('#bottom-nav'),
            font_container: $('.font-container'),
            font_button: $('#font-button')
        };
        var Win = $(window);
        var Doc = $(document);
        var RootContainer = $('#fiction_container');

        // 初始化字体大小
        var initFont = Util.StorageGetter('font_size');
        initFont = parseInt(initFont);
        if (!initFont) {
            initFont = 14;
        }
        RootContainer.css('font-size', initFont);

        // 初始化背景颜色
        var bg = Util.StorageGetter('background_color');
        if (!bg) {
            bg = '#e9dfc7';
        }
        $('body').css('background-color', bg);

        // 背景颜色外圈
        var index = Util.StorageGetter('index');
        if (index !== null) {
            var txt = $('<div></div>');
            txt.addClass('bk-container-current');
            $('.bk-container').eq(index - 1).append(txt).siblings().filter('.bk-container').empty();
        }


        var readerModel;
        var readerUI;
        function main() {
            // 整个项目的入口函数
            readerModel = ReaderModel();
            readerUI = ReaderBaseFrame(RootContainer);
            readerModel.init(function(data) {
                readerUI(data);
            });
            EventHanlder();
        }

        function ReaderModel() {
            //实现和阅读器相关数据交互方法
            var Chapter_id;
            var ChapterTotal;
            var init = function(UIcallback) {
            	// 普通回调
                // getFictionInfo(function() {
                //     getCurChapterContent(Chapter_id, function(data) {
                //         UIcallback && UIcallback(data);
                //     });
                // });
                
                // Promise
                getFictionInfoPromise()
                	.then(function(d) {
                		return getCurChapterContentPromise();
                	})
                	.then(function(data) {
                		UIcallback && UIcallback(data);
                	});
            };

            var getFictionInfo = function(callback) {
                $.get('data/chapter.json', function(data) {
                	// 获得章节信息之后的回调
                    Chapter_id = Util.StorageGetter('last_chapter_id');
                    if (Chapter_id == null) {
                        Chapter_id = data.chapters[1].chapter_id;
                    }
                    ChapterTotal = data.chapters.length;
                    callback && callback();
                }, 'json');
            };

            var getFictionInfoPromise = function() {
            	return new Promise(function(resolve, reject) {
	            	$.get('data/chapter.json', function(data) {
	            		// 获得章节信息之后的回调
	            	    if(data.result === 0) {
	            	    	Chapter_id = Util.StorageGetter('last_chapter_id');
	            	    	if (Chapter_id == null) {
	            	    	    Chapter_id = data.chapters[1].chapter_id;
	            	    	}
	            	    	ChapterTotal = data.chapters.length;
	            	    	resolve(Chapter_id);
	            	    } else {
	            	    	reject({msg: 'fail'});
	            	    }
	            	}, 'json');
	            });
            }

            var getCurChapterContent = function(chapter_id, callback) {
                $.get('data/data' + chapter_id + '.json', function(data) {
                    if (data.result === 0) {
                        var url = data.jsonp;
                        Util.getJSONP(url, function(data) {
                            callback && callback(data);
                        });
                    }
                }, 'json');
            };

            var getCurChapterContentPromise = function() {
            	return new Promise(function(resolve, reject) {
	            	$.get('data/data' + Chapter_id + '.json', function(data) {
	            	    if (data.result === 0) {
	            	        var url = data.jsonp;
	            	        Util.getJSONP(url, function(data) {
	            	            resolve(data);
	            	        });
	            	    } else {
	            	    	reject({msg: 'fail'});
	            	    }
	            	}, 'json');
	            });
            }

            var prevChapter = function(UIcallback) {
                Chapter_id = parseInt(Chapter_id, 10);
                if (Chapter_id === 1) {
                    return;
                }
                Chapter_id -= 1;
                getCurChapterContent(Chapter_id, UIcallback);
                Util.StorageSetter('last_chapter_id', Chapter_id);
            };
            var nextChapter = function(UIcallback) {
                Chapter_id = parseInt(Chapter_id, 10);
                if (Chapter_id === 4) {
                    return;
                }
                Chapter_id += 1;
                getCurChapterContent(Chapter_id, UIcallback);
                Util.StorageSetter('last_chapter_id', Chapter_id);
            };
            return {
                init: init,
                prevChapter: prevChapter,
                nextChapter: nextChapter
            }
        }

        function ReaderBaseFrame(container) {
            // 渲染基本的UI结构
            function parseChapterData(jsonData) {
                var jsonObj = JSON.parse(jsonData);
                var html = '<h4>' + jsonObj.t + '</h4>';
                for (var i = 0; i < jsonObj.p.length; i++) {
                    html += '<p>' + jsonObj.p[i] + '</p>';
                }
                return html;
            }
            return function(data) {
            	Win.scrollTop(0);
                container.html(parseChapterData(data));
            }
        }

        function EventHanlder() {
        	// 交互的事件绑定

            // 实现唤醒上下边栏功能
            $('#action_mid').click(function() {
                if(Dom.top_nav.css('display') === 'none') {
                	Dom.bottom_nav.show();
                	Dom.top_nav.show();
                } else {
                	Dom.bottom_nav.hide();
                	Dom.top_nav.hide();
                	Dom.font_container.hide();
                	Dom.font_button.removeClass('current');
                }
            });

            // 滚动隐藏
            Win.scroll(function() {
                Dom.top_nav.hide();
                Dom.bottom_nav.hide();
                Dom.font_container.hide();
                Dom.font_button.removeClass('current');
            });

            // 实现唤醒字体面板功能
            Dom.font_button.click(function() {
                if(Dom.font_container.css('display') === 'none') {
                	Dom.font_container.show();
                	Dom.font_button.addClass('current');
                } else {
                	Dom.font_container.hide();
                	Dom.font_button.removeClass('current');
                }
            });

            // 实现设置字号功能
            $('#large-font').click(function() {
                if (initFont >= 20) {
                    return;
                }
                initFont += 1;
                RootContainer.css('font-size', initFont);
                Util.StorageSetter('font_size', initFont);
            });
            $('#samll-font').click(function() {
                if (initFont <= 12) {
                    return;
                }
                initFont -= 1;
                RootContainer.css('font-size', initFont);
                Util.StorageSetter('font_size', initFont);
            });

            //实现设置背景功能
            $('.bk-container').click(function() {
                var txt = $('<div></div>');
                txt.addClass('bk-container-current');
                $(this).append(txt).siblings().filter('.bk-container').empty();
                bg = $(this).css('background-color');
                $('body').css('background-color', bg);
                Util.StorageSetter('background_color', bg);
                Util.StorageSetter('index', $(this).index());
                $('#day-button').hide();
                $('#night-button').show();
            });

            // 实现夜间模式功能
            $('#night-button').click(function() {
                $('body').css('background-color', '#0f1410');
                $(this).hide();
                $('#day-button').show();
            });
            $('#day-button').click(function() {
                $('body').css('background-color', bg);
                $(this).hide();
                $('#night-button').show();
            });

            $('#prev_button').click(function() {
                readerModel.prevChapter(function(data) {
                    readerUI(data);
                });
            });
            $('#next_button').click(function() {
                readerModel.nextChapter(function(data) {
                    readerUI(data);
                });
            });
        }

        main();
    })();
    </script>
</body>

</html>